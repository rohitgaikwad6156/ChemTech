<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chem-Assistant: Voice-Activated Chemistry Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FIX: Explicitly load marked.js for stable Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.2/marked.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .mic-button {
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .mic-button:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
        }
        .mic-listening {
            animation: pulse-red 1s infinite;
            background-color: #ef4444; /* Tailwind red-500 */
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .container-card {
            background-color: #ffffff;
            border: 1px solid #e2e8f0;
            max-width: 90%;
        }
        /* Style for citation links */
        #citations a {
            color: #2563eb;
            text-decoration: none;
            word-break: break-all;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Application Container -->
    <div id="app" class="container-card p-6 md:p-10 rounded-xl shadow-2xl w-full lg:w-3/5">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-700">Chem-Assistant</h1>
            <p class="text-gray-500 mt-2">Your Voice-Activated Chemistry Tutor and Project Helper</p>
        </header>

        <!-- Voice Interaction Area -->
        <div class="flex flex-col items-center space-y-6">

            <!-- Microphone Button -->
            <button id="micButton" class="mic-button bg-blue-600 text-white w-20 h-20 rounded-full flex items-center justify-center focus:outline-none focus:ring-4 focus:ring-blue-300 transition duration-300">
                <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3.53-2.61 6.44-6 6.93V21h2v2H9v-2h2v-3.07c-3.39-.49-6-3.4-6-6.93H5c0 4.28 3.5 7.85 8 8.1v3h2v-3.1c4.5-.25 8-3.82 8-8.1h-2z"/>
                </svg>
            </button>
            <p id="statusText" class="text-lg font-semibold text-gray-700">Tap the mic to ask a question...</p>
        </div>

        <!-- Text Input Fallback (for non-speech browsers or specific queries) -->
        <div class="mt-8">
            <label for="textQuery" class="block text-sm font-medium text-gray-700 mb-2">Or, type your question here:</label>
            <div class="flex space-x-3">
                <input type="text" id="textQuery" placeholder="E.g., What is the formula for sulfuric acid?" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <button id="submitButton" class="bg-green-500 text-white p-3 rounded-lg font-medium hover:bg-green-600 transition duration-150 shadow-md">Submit</button>
            </div>
        </div>

        <!-- Response Area -->
        <div class="mt-10 p-5 bg-gray-50 border border-gray-200 rounded-xl shadow-inner min-h-[150px]">
            <h2 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Response:</h2>
            <div id="responseArea" class="text-gray-700 leading-relaxed italic">
                Awaiting your first chemistry question...
            </div>
            
            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="hidden text-center mt-4">
                <svg class="animate-spin h-5 w-5 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="text-sm text-gray-500 mt-1">Thinking...</p>
            </div>
            
            <!-- Citations -->
            <div id="citations" class="text-xs text-gray-600 mt-4 pt-2 border-t hidden">
                <strong class="font-bold">Sources:</strong>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration & Initialization ---
        const API_KEY = ""; // Canvas will provide this if needed
        const API_URL_BASE = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const GEMINI_URL = `${API_URL_BASE}${MODEL_NAME}:generateContent?key=${API_KEY}`;
        
        // UI Elements
        const micButton = document.getElementById('micButton');
        const statusText = document.getElementById('statusText');
        const responseArea = document.getElementById('responseArea');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const textQueryInput = document.getElementById('textQuery');
        const submitButton = document.getElementById('submitButton');
        const citationsDiv = document.getElementById('citations');

        // State variables
        let isListening = false;
        let recognition = null;
        const synth = window.speechSynthesis;
        let currentUtterance = null;
        
        // --- Core Utility Functions ---

        /**
         * Implements exponential backoff for API calls.
         * @param {function} fn - The function to retry.
         * @param {number} maxRetries - Maximum number of retries.
         */
        async function fetchWithRetry(fn, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fn();
                    if (!response.ok) {
                        // FIX: Attempt to read the error body for clearer debugging information
                        let errorDetail = await response.text();
                        try {
                            const errorJson = JSON.parse(errorDetail);
                            // Look for the specific error message property in the API response
                            errorDetail = errorJson.error ? errorJson.error.message : errorDetail;
                        } catch (e) {
                            // If not JSON, use the raw text as the error detail
                        }
                        throw new Error(`HTTP Error ${response.status}: ${errorDetail}`);
                    }
                    return response;
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Re-throw if last attempt failed
                    }
                    // Wait for exponential delay (1s, 2s, 4s, ...)
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        /**
         * Converts Markdown text (like $H_2SO_4$) to HTML for better display.
         * @param {string} text - The input text from the LLM.
         * @returns {string} HTML formatted text.
         */
        function formatMarkdownForChemistry(text) {
            // Converts inline LaTeX/chemistry formulas ($...$) to sup/sub HTML
            return text.replace(/\$([^\$]+)\$/g, (match, formula) => {
                let html = formula;
                // Replace numbers immediately following letters with subscripts
                html = html.replace(/([a-zA-Z]+)(\d+)/g, '$1<sub>$2</sub>');
                // Replace superscripts (e.g., charge notation like ^2+)
                html = html.replace(/\^([^\s]+)/g, '<sup>$1</sup>');
                return html;
            });
        }

        // --- Speech Recognition ---
        
        function setupSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                statusText.textContent = "Speech Recognition not supported in this browser.";
                micButton.disabled = true;
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                micButton.classList.add('mic-listening');
                micButton.classList.remove('bg-blue-600');
                statusText.textContent = "Listening... Speak your chemistry question now.";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                textQueryInput.value = transcript;
                statusText.textContent = `Recognized: "${transcript}"`;
                fetchChemistryAnswer(transcript);
            };

            recognition.onerror = (event) => {
                isListening = false;
                micButton.classList.remove('mic-listening');
                micButton.classList.add('bg-blue-600');
                statusText.textContent = `Error: ${event.error}. Tap to retry.`;
                console.error('Speech recognition error:', event.error);
                loadingIndicator.classList.add('hidden');
            };

            recognition.onend = () => {
                isListening = false;
                micButton.classList.remove('mic-listening');
                micButton.classList.add('bg-blue-600');
                if (statusText.textContent.startsWith("Listening")) {
                     statusText.textContent = "No speech detected. Tap the mic to try again.";
                }
            };
        }

        function startSpeechRecognition() {
            if (isListening) {
                recognition.stop();
                return;
            }
            if (synth.speaking) {
                synth.cancel(); // Stop speaking if currently talking
            }
            try {
                 recognition.start();
            } catch(e) {
                // Ignore "recognition already started" error on rapid clicks
                console.warn("Recognition start attempted while already active:", e);
            }
        }
        
        // --- Text-to-Speech (TTS) ---

        /**
         * Speaks the generated text response.
         * Uses the browser's native SpeechSynthesis API.
         * @param {string} text - The text to be spoken.
         */
        function speakResponse(text) {
            if (synth.speaking) {
                synth.cancel();
            }
            // Strip out markdown formatting for clearer speech
            const cleanText = text.replace(/(\*\*|__|\*|_)/g, '').replace(/(\$|~|`)/g, '');
            
            currentUtterance = new SpeechSynthesisUtterance(cleanText);
            
            // Optional: select a voice
            const voices = synth.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.lang.startsWith('en') && 
                voice.name.includes('Google')
            ) || voices.find(voice => voice.lang.startsWith('en'));

            if (preferredVoice) {
                currentUtterance.voice = preferredVoice;
            }

            currentUtterance.pitch = 1.0;
            currentUtterance.rate = 1.0;

            synth.speak(currentUtterance);
        }

        // --- Gemini API Call ---

        async function fetchChemistryAnswer(query) {
            if (!query) {
                statusText.textContent = "Please provide a query.";
                return;
            }
            
            // Clear previous results
            responseArea.innerHTML = '';
            citationsDiv.innerHTML = '<strong class="font-bold">Sources:</strong>';
            citationsDiv.classList.add('hidden');
            loadingIndicator.classList.remove('hidden');
            
            statusText.textContent = "Processing query...";

            const systemPrompt = "You are a specialized chemistry tutor and project helper. Provide clear, accurate, and concise answers related to chemistry, focusing on scientific facts, reactions, and concepts. Answer in a friendly, encouraging, and informative tone. Keep the answer brief and direct, suitable for a voice assistant. Use inline markdown for formatting, and LaTeX-style syntax for formulas ($H_2SO_4$) which will be converted to HTML subscripts/superscripts.";
            
            const payload = {
                contents: [{ parts: [{ text: query }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                }
            };

            try {
                const response = await fetchWithRetry(() => 
                    fetch(GEMINI_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    })
                );

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    // 1. Format and Display Text
                    const formattedText = formatMarkdownForChemistry(text);
                    // marked.parse is now safely available due to the CDN link in the header
                    responseArea.innerHTML = marked.parse(formattedText); 
                    speakResponse(text);

                    // 2. Extract and Display Citations
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);

                        if (sources.length > 0) {
                            citationsDiv.classList.remove('hidden');
                            sources.forEach((source, index) => {
                                const link = document.createElement('a');
                                link.href = source.uri;
                                link.target = '_blank';
                                link.textContent = `${source.title}`;
                                link.className = "hover:underline";

                                const item = document.createElement('span');
                                item.className = "mr-2";
                                item.appendChild(link);
                                
                                citationsDiv.appendChild(item);
                            });
                        }
                    }
                    
                    statusText.textContent = "Response ready.";

                } else {
                    responseArea.textContent = "Sorry, I couldn't generate a useful chemistry response for that query. The model returned no text.";
                    speakResponse("Sorry, I couldn't generate a useful chemistry response.");
                    statusText.textContent = "Generation failed.";
                }

            } catch (error) {
                // Display the specific error message from the improved fetchWithRetry function
                responseArea.textContent = `API Error: ${error.message}. Please check your query or console for details.`;
                speakResponse("I encountered an API error. Please check the screen for details.");
                statusText.textContent = "API Error.";
                console.error('API Call Error:', error);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // --- Event Listeners and Setup ---
        
        // 1. Setup Speech Recognition
        setupSpeechRecognition();

        // 2. Click listeners
        micButton.addEventListener('click', startSpeechRecognition);
        submitButton.addEventListener('click', () => {
            const query = textQueryInput.value.trim();
            if (query) {
                fetchChemistryAnswer(query);
            } else {
                statusText.textContent = "Please enter text or use the microphone.";
            }
        });

        // 3. Enter key listener for text input
        textQueryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitButton.click();
            }
        });
        
        // 4. Pre-fetch voices for TTS immediately on load
        window.onload = function() {
            if(synth.onvoiceschanged !== undefined) {
                synth.onvoiceschanged = () => { /* Voices loaded */ };
            }
        };

    </script>
</body>
</html>
